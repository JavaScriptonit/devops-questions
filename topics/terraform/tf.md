## Вопросы:
1. Какие объекты создаёт terraform? Где лучше всего хранить terraform? Как лучше всего делить созданные объекты в terraform? Единый стейт или Terragrunt в каких случаях используется?
2. Где хранить .tfstate? 
3. Что делать если произошло изменение файла состояния (.tfstate) вручную? 
4. 

## 1. Какие объекты создаёт terraform? Где лучше всего хранить terraform? Как лучше всего делить созданные объекты в terraform? Единый стейт или Terragrunt в каких случаях используется? (Terraform)

1. **Определение инфраструктуры:** На языке конфигурации Terraform (HCL) описывается желаемое состояние инфраструктуры, включая виртуальные машины, сети, хранилища и другие ресурсы.

2. **Инициализация:** Terraform инициализируется для загрузки необходимых провайдеров и модулей, указанных в конфигурации.

3. **Планирование:** Terraform генерирует план изменений, которые будут применены к текущей инфраструктуре для достижения желаемого состояния.

4. **Применение:** После проверки плана изменений, Terraform применяет их, создавая, изменяя или удаляя ресурсы в облаке или локальной инфраструктуре.

При работе с `Terraform` обычно используются модули, переменные и state файлы для организации и управления конфигурацией. Модули позволяют организовать конфигурацию на более мелкие и переиспользуемые блоки, переменные используются для передачи значений в конфигурацию, а **state файл хранит текущее состояние инфраструктуры**.

`Terragrunt` - это дополнительный инструмент, который облегчает управление конфигурациями Terraform, особенно при работе с крупными проектами. Terragrunt предоставляет дополнительные функции, такие как управление переменными, блокировка состояния и использование модулей Terraform.

Terraform создает различные объекты в облаке или локальной инфраструктуре в соответствии с описанными в конфигурации ресурсами. Некоторые из типичных объектов, которые Terraform может создать, включают виртуальные машины, сетевые ресурсы (например, сети, подсети, балансировщики нагрузки), хранилища данных (например, базы данных, объектные хранилища), и многое другое.

### Что касается хранения Terraform конфигурации и состояния, рекомендуется использовать следующие подходы:

1. **Хранение конфигурации:** Terraform конфигурационные файлы лучше всего хранить в системе контроля версий, таком как Git. Это обеспечивает версионирование, аудит и совместную работу над конфигурацией.

2. **Хранение состояния:** Состояние Terraform, которое отслеживает текущее состояние инфраструктуры, должно быть храниться в безопасном и надежном месте. Рекомендуется использовать удаленное хранилище состояния, такое как Terraform Cloud, AWS S3, Azure Blob Storage и т. д.

Что касается деления созданных объектов в Terraform, хорошей практикой является использование модулей для организации и переиспользования конфигурации. Модули позволяют разделить инфраструктурные ресурсы на логические блоки, что упрощает управление и поддержку конфигурации.

### Относительно использования единого состояния Terraform против Terragrunt, обычно Terragrunt используется в следующих случаях:

- Когда требуется управление переменными и конфигурациями на разных уровнях (например, на уровне окружений).
- Когда необходима более гибкая организация конфигураций и модулей Terraform.
- При работе с крупными проектами, где требуется более сложное управление состоянием и конфигурациями.

Таким образом, Terraform создает различные объекты инфраструктуры, конфигурационные файлы лучше всего хранить в системе контроля версий, состояние - в удаленном хранилище, объекты можно лучше всего делить на модули, и Terragrunt используется в случаях, когда требуется более сложное управление конфигурациями и состоянием Terraform.

## 2. Где хранить .tfstate? (Terraform)

https://cloud.yandex.ru/ru/docs/tutorials/infrastructure-management/terraform-state-storage#bash_1 - Загрузка состояний Terraform в Yandex Object Storage

Хранение файла состояния (.tfstate) в системе контроля версий, такой как GitLab или GitHub, не является рекомендуемой практикой. Файл состояния Terraform содержит чувствительную информацию о текущем состоянии инфраструктуры, и его изменения могут быть критическими для безопасности и целостности инфраструктуры.

Рекомендуется хранить файл состояния в безопасном и надежном удаленном хранилище, таком как AWS S3, Azure Blob Storage, Google Cloud Storage или Terraform Cloud. Это обеспечивает централизованное управление состоянием, защиту от потери данных и возможность совместной работы над инфраструктурой.

Если файл состояния будет храниться в системе контроля версий, это может привести к проблемам с конкурентным доступом, возможными конфликтами при слиянии изменений и уязвимостям безопасности. Поэтому для хранения .tfstate рекомендуется использовать специализированные инструменты и сервисы, предназначенные для управления состоянием Terraform.

```
terraform {
  required_providers {
    yandex = {
      source = "yandex-cloud/yandex"
    }
  }

  backend "s3" {
    endpoints = {
      s3 = "https://storage.yandexcloud.net"
    }
    bucket = "<имя_бакета>"
    region = "ru-central1"
    key    = "<путь_к_файлу_состояния_в_бакете>/<имя_файла_состояния>.tfstate"

    skip_region_validation      = true
    skip_credentials_validation = true
    skip_requesting_account_id  = true # Необходимая опция Terraform для версии 1.6.1 и старше.
    skip_s3_checksum            = true # Необходимая опция при описании бэкенда для Terraform версии 1.6.3 и старше.

  }
}

provider "yandex" {
  zone      = "<зона_доступности_по_умолчанию>"
}
```

## 3. Что делать если произошло изменение файла состояния (.tfstate) вручную? (Terraform)

Изменение файла состояния (.tfstate) вручную не рекомендуется, так как это может привести к несоответствиям между фактическим состоянием инфраструктуры и содержимым файла состояния. Это может вызвать ошибки развертывания, потерю данных или другие проблемы.

Если в файл состояния был внесен код вручную, то рекомендуется принять следующие шаги:

1. **Откат изменений:** Попробуйте откатить изменения в файле состояния до предыдущего рабочего состояния, если это возможно. Это можно сделать, например, через систему контроля версий, если у вас есть сохраненные версии файла состояния.

2. **Восстановление из резервной копии:** Если у вас есть резервные копии файла состояния, попробуйте восстановить состояние из последней рабочей резервной копии.

3. **Пересоздание ресурсов:** Если не удается восстановить файл состояния, возможно придется пересоздать ресурсы, описанные в файле состояния. Это может быть времязатратным процессом, но иногда это единственный способ восстановить целостность инфраструктуры.

Для предотвращения подобных ситуаций и обеспечения безопасной работы с файлом состояния (.tfstate) рекомендуется следовать следующим best practices:

1. **Используйте удаленное хранилище состояния:** Храните файл состояния в удаленном и безопасном хранилище, таком как AWS S3, Azure Blob Storage или Terraform Cloud. Это обеспечивает централизованное управление состоянием и защиту от потери данных.

2. **Не изменяйте файл состояния вручную:** Избегайте внесения изменений в файл состояния вручную, используйте Terraform для управления состоянием и инфраструктурой.

3. **Регулярно создавайте резервные копии:** Регулярно создавайте резервные копии файла состояния, чтобы иметь возможность восстановиться в случае необходимости.

### Если в файле состояния (.tfstate) были внесены изменения вручную, то:
Рекомендуется исправить это с помощью Terraform, а именно через использование команды `terraform import`.

Команда `terraform import` позволяет импортировать существующий ресурс в управляемый Terraform состоянием. Это позволит Terraform узнать о существующем ресурсе и начать управлять им, не изменяя его текущего состояния.

Изменение файла состояния (.tfstate) напрямую не рекомендуется, так как это может привести к несоответствиям между фактическим состоянием инфраструктуры и содержимым файла состояния, что может вызвать проблемы при развертывании и управлении инфраструктурой.

Поэтому, если были внесены изменения в файл состояния вручную, рекомендуется использовать команду `terraform import` для корректного импорта существующего ресурса в Terraform и обновления состояния.

