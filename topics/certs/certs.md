## Вопросы:
1. Сертификаты. Что такое mTLS? Работал ли с ним?
2. Чем сотрудник DevOps должен выпускать сертификаты на серверах Ubuntu, MacOS, CentOS?
3. Приведи примеры создания сертов.
4. Приведи примеры создания сертов в k8s.
5. Передавал ли при создании сертификата параметр - роль?
6. Серверные серты. Надо выпустить 1 или 10 сертов под 10 ингрессов? 
7. Серверные серты. Можно ли выпустить 1 серт под 10 ингрессов (10 сервисов)? 
8. Что напишешь в сертификате в поле SN для такого случая? 

## 1. Сертификаты. Что такое mTLS? Работал ли с ним? (tls)

1) Взаимная аутентификация TLS (mTLS) - это расширение протокола TLS, которое обеспечивает двустороннюю аутентификацию между клиентом и сервером. Это означает, что как клиент, так и сервер должны предъявить свои сертификаты для проверки подлинности друг друга перед установлением защищенного соединения.

2) Отличие между mTLS и обычным TLS заключается в том, что в случае mTLS не только сервер предъявляет свой сертификат клиенту для проверки, но и клиент предъявляет свой сертификат серверу. Это обеспечивает более строгий уровень безопасности и аутентификации для обеих сторон.

3) Пример использования mTLS с командами и шагами:

Шаги для установки mTLS:

1. Генерация сертификатов:
   - Сгенерируйте сертификат и закрытый ключ для сервера:
     ```
     openssl req -newkey rsa:2048 -nodes -keyout server-key.pem -out server-csr.pem
     openssl x509 -req -in server-csr.pem -signkey server-key.pem -out server-cert.pem
     ```
   - Сгенерируйте сертификат и закрытый ключ для клиента:
     ```
     openssl req -newkey rsa:2048 -nodes -keyout client-key.pem -out client-csr.pem
     openssl x509 -req -in client-csr.pem -signkey client-key.pem -out client-cert.pem
     ```

2. Настройка сервера:
   - Настройте сервер для проверки сертификата клиента при установлении соединения.

3. Настройка клиента:
   - Настройте клиента для предъявления своего сертификата серверу при установлении соединения.

4. Установление защищенного соединения:
   - Клиент и сервер обмениваются сертификатами и проверяют их подлинность.
   - Если аутентификация проходит успешно, устанавливается защищенное соединение.

mTLS может использоваться для обеспечения безопасной двусторонней аутентификации между клиентом и сервером в сценариях, где требуется высокий уровень безопасности, например, в финансовых приложениях, медицинских системах или взаимодействиях между микросервисами. После установления защищенного соединения, клиент и сервер могут обмениваться данными, обеспечивая конфиденциальность и целостность информации.

## 2. Чем сотрудник DevOps должен выпускать сертификаты на серверах Ubuntu, MacOS, CentOS? (openssl)

Примеры выпуска сертификатов (Пользовательские и серверные), команды и шаги:

1) Сотрудник DevOps может выпускать сертификаты на серверах Ubuntu, MacOS и CentOS с использованием утилиты `OpenSSL` или других инструментов для генерации сертификатов и управления ими.

2) Примеры выпуска пользовательских и серверных сертификатов с помощью OpenSSL:

- Генерация самоподписанного серверного сертификата:
```
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout server-key.pem -out server-cert.pem
```

- Генерация запроса на сертификат (CSR) для клиентского сертификата:
```
openssl req -new -newkey rsa:2048 -nodes -keyout client-key.pem -out client-csr.pem
```

- Подписание CSR для создания клиентского сертификата:
```
openssl x509 -req -in client-csr.pem -CA server-cert.pem -CAkey server-key.pem -CAcreateserial -out client-cert.pem -days 365
```

3) Сертификаты для Kubernetes (k8s) отличаются от обычных сертификатов тем, что они используются для обеспечения безопасной связи и аутентификации между компонентами Kubernetes, такими как API сервер, kubelet, etcd и другие. Процесс создания сертификатов для Kubernetes обычно включает в себя генерацию сертификатов для различных компонентов кластера и их последующее использование при настройке безопасности кластера.

Отличия процесса создания сертификатов для Kubernetes включают в себя специфические требования к сертификатам (например, уникальные имена для каждого компонента), использование утилиты kubectl или инструментов управления кластером для генерации и установки сертификатов, а также необходимость обновления сертификатов в соответствии с политиками безопасности кластера.

## 3. Приведи примеры создания сертов. (openssl)

1) `openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout server-key.pem -out server-cert.pem`:
   - `openssl req`: использует OpenSSL для выполнения операций с запросами на сертификаты (CSR).
   - `-x509`: указывает, что нужно сгенерировать самоподписанный сертификат.
   - `-nodes`: не шифрует закрытый ключ сертификата.
   - `-days 365`: устанавливает срок действия сертификата на 365 дней.
   - `-newkey rsa:2048`: генерирует новую пару ключей RSA с длиной 2048 бит.
   - `-keyout server-key.pem`: указывает имя файла, в который будет сохранен закрытый ключ.
   - `-out server-cert.pem`: указывает имя файла, в который будет сохранен самоподписанный сертификат.

2) `openssl req -new -newkey rsa:2048 -nodes -keyout client-key.pem -out client-csr.pem`:
   - `openssl req`: используется для операций с запросами на сертификаты.
   - `-new`: создает новый запрос на сертификат.
   - `-newkey rsa:2048`: генерирует новую пару ключей RSA с длиной 2048 бит.
   - `-nodes`: не шифрует закрытый ключ сертификата.
   - `-keyout client-key.pem`: указывает имя файла, в который будет сохранен закрытый ключ клиентского сертификата.
   - `-out client-csr.pem`: указывает имя файла, в который будет сохранен запрос на сертификат (CSR).

3) `openssl x509 -req -in client-csr.pem -CA server-cert.pem -CAkey server-key.pem -CAcreateserial -out client-cert.pem -days 365`:
   - `openssl x509`: используется для операций с сертификатами X.509.
   - `-req`: указывает, что входной файл является запросом на сертификат.
   - `-in client-csr.pem`: указывает входной файл (запрос на сертификат клиента).
   - `-CA server-cert.pem`: указывает файл самоподписанного сертификата, который будет использоваться в качестве Центра сертификации.
   - `-CAkey server-key.pem`: указывает файл закрытого ключа Центра сертификации.
   - `-CAcreateserial`: создает серийный номер для сертификата.
   - `-out client-cert.pem`: указывает имя файла, в который будет сохранен клиентский сертификат.
   - `-days 365`: устанавливает срок действия сертификата на 365 дней.

## 4. Приведи примеры создания сертов в k8s. (openssl) (k8s)

1) Пример создания сертификатов через kubectl для Kubernetes (серверного и пользовательского):

Создание серверного сертификата для Kubernetes API сервера:
```bash
kubectl create secret tls server-certificate --cert=server-cert.pem --key=server-key.pem
```

Создание пользовательского сертификата для доступа к Kubernetes кластеру:
```bash
kubectl create secret tls client-certificate --cert=client-cert.pem --key=client-key.pem
```

2) Для настройки и создания сертификатов для Kubernetes API сервера, kubelet и etcd обычно используют следующие шаги:

- Генерация сертификатов и закрытых ключей для каждого компонента с помощью утилиты OpenSSL или других инструментов.
- Создание конфигурационных файлов (например, CSR файлов) для запросов на сертификаты.
- Подписание сертификатов Центром сертификации или самоподпись.
- Установка сертификатов на соответствующие компоненты Kubernetes.

Примеры кода для создания сертификатов могут выглядеть следующим образом:
```bash
# Генерация сертификата для API сервера
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout api-server-key.pem -out api-server-cert.pem

# Генерация сертификата для kubelet
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout kubelet-key.pem -out kubelet-cert.pem

# Генерация сертификата для etcd
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout etcd-key.pem -out etcd-cert.pem
```

3) Обычно сертификаты для Kubernetes создаются администраторами кластера или специалистами по безопасности. Сертификаты хранятся в защищенном хранилище, доступ к которому имеют только авторизованные пользователи или приложения. Это может быть специализированное хранилище сертификатов (например, Key Management Service) или просто зашифрованные файлы на сервере кластера. Важно обеспечить безопасность хранения сертификатов, так как они могут предоставлять доступ к чувствительным данным и ресурсам в кластере Kubernetes.

## 5. Передавал ли при создании сертификата параметр - роль? (openssl) (k8s)

Для создания сертификатов важно указывать роль сертификата, будь то серверный или клиентский сертификат. 

Примеры с указанием роли сертификата:

1) Пример создания серверного сертификата для Kubernetes API сервера:
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout server-key.pem -out server-cert.pem
```

2) Пример создания клиентского сертификата для доступа к Kubernetes кластеру:
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout client-key.pem -out client-cert.pem
```

При создании сертификатов для Kubernetes API сервера, kubelet, etcd и других компонентов, важно явно указывать их роль (серверный или клиентский), чтобы обеспечить правильную настройку аутентификации и безопасности в кластере Kubernetes.

## 6. Серверные серты. Надо выпустить 1 или 10 сертов под 10 ингрессов? (openssl) (k8s)
У нас есть НС в кубере и есть 10 ингрессов чтобы на наш фронт (10 сервисов) ходили клиенты.
Отдельный сервис1., сервис2.домен
И там надо сделать https
Вопрос:
Надо выпустить 1 или 10 сертов под это всё ?
-----------------------

Для обеспечения безопасного соединения по HTTPS между клиентами и вашими 10 сервисами через ингрессы в Kubernetes, вам необходимо будет выпустить отдельный серверный сертификат для каждого домена сервиса. Это означает, что вам потребуется выпустить 10 отдельных серверных сертификатов для каждого домена сервиса.

Каждый сертификат будет соответствовать конкретному домену сервиса и будет использоваться для обеспечения безопасного HTTPS-соединения для этого сервиса. При этом клиенты смогут безопасно общаться с каждым сервисом через соответствующий ингресс.

Таким образом, в вашем случае вам потребуется выпустить 10 отдельных серверных сертификатов для каждого домена сервиса, чтобы обеспечить безопасное HTTPS-соединение между клиентами и вашими сервисами в Kubernetes.

## 7. Серверные серты. Можно ли выпустить 1 серт под 10 ингрессов (10 сервисов)? (openssl) (k8s)

Можно использовать один wildcard-сертификат для обеспечения HTTPS-соединения для нескольких доменов сервисов. Wildcard-сертификат имеет шаблонное имя, которое соответствует нескольким поддоменам. Например, сертификат для `*.example.com` будет соответствовать `service1.example.com`, `service2.example.com` и т.д.

Вот пример того, как можно создать и использовать wildcard-сертификат в Kubernetes:

1. Создание wildcard-сертификата (например, `*.example.com`):
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout wildcard-key.pem -out wildcard-cert.pem -subj "/CN=*.example.com"
```

2. Создание секрета Kubernetes из wildcard-сертификата:
```bash
kubectl create secret tls wildcard-cert --key=wildcard-key.pem --cert=wildcard-cert.pem
```

3. Настройка ингресса для использования wildcard-сертификата:
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: example-ingress
spec:
  tls:
  - hosts:
    - "*.example.com"
    secretName: wildcard-cert
  rules:
  - host: service1.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: service1
            port:
              number: 80
  - host: service2.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: service2
            port:
              number: 80
```

4. Проверка работоспособности: обратитесь к своим сервисам через HTTPS, используя домены `service1.example.com` и `service2.example.com`. Убедитесь, что соединение устанавливается без ошибок.

Использование wildcard-сертификата позволяет упростить управление сертификатами для нескольких сервисов с разными доменами, но имейте в виду, что это также увеличивает уровень доступа для всех сервисов, использующих этот сертификат.

## 8. Что напишешь в сертификате в поле SN для такого случая? (openssl) (k8s)

Для wildcard-сертификата, который будет использоваться для нескольких поддоменов, в поле Subject Name (SN) можно указать следующее значение:

Common Name (CN): *.example.com

Это означает, что сертификат будет действителен для всех поддоменов домена `example.com`.Wildcard-символ `*` позволяет сделать шаблонное совпадение для всех поддоменов.

1) Поле Common Name (CN) в сертификате SSL/TLS используется для указания основного домена (или хоста), для которого выдается сертификат. Обычно это поле используется для указания точного домена (например, www.example.com). Вот пример, когда поле CN может быть использовано:

Представьте, что у вас есть один конкретный сервис с доменом `service.example.com`, и вы хотите создать сертификат только для этого домена. В этом случае вы можете указать `service.example.com` в поле CN сертификата.

2) Можно указать CN в команде для создания сертификата с помощью OpenSSL. Вот пример команды:

```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout example-key.pem -out example-cert.pem -subj "/CN=service.example.com"
```

В этой команде мы указываем `/CN=service.example.com` в качестве значения для поля Common Name (CN) сертификата. После выполнения этой команды, сертификат будет содержать указанный домен в поле CN.
